---
/**
 * Client-side PIN gate for member pages.
 * Compares SHA-256 hash of entered code against MEDLEM_PIN_HASH env var.
 * Stores validation in sessionStorage so members only enter it once per session.
 */
const pinHash = import.meta.env.PUBLIC_MEDLEM_PIN_HASH || '';
---

{/* Login gate - shown by default */}
<div id="medlemGate" class="flex items-center justify-center" style="min-height: 50vh;">
  <div class="w-full max-w-xs text-center fade-up">
    <p class="text-sm tracking-[0.3em] uppercase text-gray-500 mb-6">Medlemssidor</p>
    <h2 class="text-2xl font-serif mb-8">Ange kod</h2>
    <form id="medlemForm" class="space-y-4">
      <div>
        <input
          id="medlemPin"
          type="password"
          inputmode="numeric"
          pattern="[0-9]*"
          maxlength="4"
          placeholder="····"
          autocomplete="off"
          class="w-full px-4 py-3 text-center text-2xl tracking-[0.5em] border focus:outline-none focus:border-[var(--color-ink)] transition-colors"
          style="border-color: var(--color-stone); background: white;"
        />
      </div>
      <button type="submit" class="btn-zen w-full">Logga in</button>
      <p class="text-xs text-gray-400 mt-2">Slå koden så öppnar sig dörren</p>
      <p id="medlemError" class="text-sm hidden" style="color: var(--belt-red);">Fel kod</p>
    </form>
  </div>
</div>

{/* Protected content - hidden by default */}
<div id="medlemContent" class="hidden">
  <slot />
</div>

<script is:inline define:vars={{ pinHash }}>
(function() {
  const STORAGE_KEY = 'medlem_ok';
  const gate = document.getElementById('medlemGate');
  const content = document.getElementById('medlemContent');
  const form = document.getElementById('medlemForm');
  const input = document.getElementById('medlemPin');
  const error = document.getElementById('medlemError');

  function unlock() {
    gate.classList.add('hidden');
    content.classList.remove('hidden');
    sessionStorage.setItem(STORAGE_KEY, '1');
  }

  // Auto-unlock if already validated this session
  if (sessionStorage.getItem(STORAGE_KEY) === '1') {
    unlock();
  } else {
    input.focus();
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    error.classList.add('hidden');
    const pin = input.value.trim();
    if (!pin) return;

    // Hash the entered PIN with SHA-256
    const encoder = new TextEncoder();
    const data = encoder.encode(pin);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');

    if (pinHash && hashHex === pinHash.toLowerCase()) {
      unlock();
    } else {
      error.classList.remove('hidden');
      input.value = '';
      input.focus();
    }
  });
})();
</script>
