<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Närvaroregistrering</title>
    <!-- Android mobile -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="shortcut icon" sizes="192x192" href="/fav/logoBW192x.png">
    <link rel="shortcut icon" sizes="128x128" href="/fav/logoBW128x.png">
    <link rel="manifest" href="manifest.json">
    <!-- iPhone mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/fav/logoBW128x.png">
    <link rel="apple-touch-startup-image" href="/fav/logoBW128x.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/fav/logoBW128x.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/fav/logoBW76x.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/fav/logoBW120x.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/fav/logoBW152x.png.png">
    <!-- Styles.  -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" integrity="sha256-rDWX6XrmRttWyVBePhmrpHnnZ1EPmM6WQRQl6h0h7J8=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" integrity="sha256-JDBcnYeV19J14isGd3EtnsCQK05d8PczJ5+fvEvBJvI=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.5.3/css/bootstrapValidator.min.css" integrity="sha256-gBxd65TVOCRCDC48+AXN6hhg3I/fZqE/BnwgKwdzJG4=" crossorigin="anonymous" />
    <style>
        .glyphicon.spinning {
            animation: spin 1s infinite linear;
            -webkit-animation: spin2 1s infinite linear;
            font-size: 1.5em;
        }

        @keyframes spin {
            from {
                transform: scale(1) rotate(0deg);
            }

            to {
                transform: scale(1) rotate(360deg);
            }
        }

        @-webkit-keyframes spin2 {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(360deg);
            }
        }

        html, body {
            width: auto !important;
            overflow-x: hidden !important;
        }

        td.reported {
            background: #2ecc71 !important;
        }

        td.not-reported {
            background: #e74c3c !important;
        }

        .tinyNumbers {
            font-size: 10px;
            color: white;
            opacity: 0.7;
        }

        .active {
            background-color: #2ecc71;
        }

        .btn-success, .btn-success:hover, .btn-success:active, .btn-success:visited {
            background-color: #2ecc71;
            !important;
        }

        .btn-danger, .btn-danger:hover, .btn-danger:active, .btn-danger:visited {
            background-color: #e74c3c !important;
        }
    </style>

    <!--Scripts-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <script>
        var doneDates = [];
        var missingDates = [];

        function SetSensei() {
            var sensei = $('#InputWho').val();
            if (sensei !== undefined)
                setObject('sensei', sensei);
            else {
                sensei = getObject('sensei');
                $('#InputWho').val(sensei);
            }

            return sensei;
        }

        $(document).ready(function () {
            GetPeople();

            $('#formValidateme').on('submit', function (e) {
                e.preventDefault();  //prevent form from submitting
                var datum = $('#classDate').data('datepicker').getFormattedDate('DD d M');
                if (!datum || datum === "")
                    return;

                localStorage.clear();
                postToGoogle();
            });

            $('input[type=radio][name=groupRadio]').change(
                function () {
                    SetSensei();
                    GetPeople();
                    $('#submitForm').text('Skicka in!');
                });
        });

        function GetPeople() {
            $('#laddar').show();
            SetSensei();
            var today = new Date();
            var dd = today.getDate();
            var localDate = getObject('localDate');
            var localData = getObject('localData');
            var localNewPeeps = getObject('localNewPeeps');

            dateFormat = moment(today).format('YYYY-MM-DD');

            if (localDate === dateFormat) {
                ProcessData(localData);
                ProcessNewPeople(localNewPeeps);
            }
            else {
                localStorage.clear();
                $.getJSON("https://spreadsheets.google.com/feeds/list/1TIuPOSg40X7lMrTtpZ2ws4ztBkUDLK4nL-Uh_QZm8jg/od6/public/values?alt=json",
                    function (data) {
                        //localStorage.clear();
                        setObject('localDate', dateFormat);
                        setObject('localData', data);
                        ProcessData(data);

                        $.getJSON("https://spreadsheets.google.com/feeds/list/1TIuPOSg40X7lMrTtpZ2ws4ztBkUDLK4nL-Uh_QZm8jg/2/public/values?alt=json",
                            function (newPeeps) {
                                ProcessNewPeople(newPeeps);
                                setObject('localNewPeeps', newPeeps);
                            });
                    });
            }


            function ProcessData(data) {
                $('div#namesHere').empty();
                var grupp = $('input[name=groupRadio]:checked').val();
                var margin = '';

                $.each(data.feed.entry, function (i, entry) {
                    //Name				  Count	Age	Sex	Adults	Kids
                    //Nils Karlsson	5			35	MAN	JA			JA

                    var id = entry.gsx$name.$t.replace(/ /g, '_');
                    var age = entry.gsx$age.$t;
                    if (age === "") {
                        age = "fråga ålder!";
                    }
                    var person = '<div class="form-group"' + margin + '>' +
                        '<div class="col-xs-2">' +
                        '<input type="checkbox" class="switch form-control" id="' + id + '" data-size="small" data-toggle="toggle" data-on="Ja" data-off="Nej" data-onstyle="success" data-offstyle="danger">' +
                        '</div><h4 style="font-size:1.2em"><label style="text-align: left;" for="' + id + '" class="col-xs-10 control-label" data-name="' + entry.gsx$name.$t + '">' + entry.gsx$name.$t + ' <sup>' + age + '</sup></label></h4></span></div>';

                    if (grupp === "Barn" && entry.gsx$kids.$t === 'JA') {
                        $('div#namesHere').append(person);
                    }
                    else if (grupp === "Vuxna" && entry.gsx$adults.$t === 'JA') {
                        $('div#namesHere').append(person);
                    }
                    // Fix this later with right classification
                    else if (grupp === "Ungdomar" && entry.gsx$youths.$t === 'JA') {
                        $('div#namesHere').append(person);
                    }
                    else if (grupp === "Aikidolek" && entry.gsx$play.$t === 'JA') {
                        $('div#namesHere').append(person);
                    }
                    margin = ' style="margin-top:-5px"';
                });

                $('.switch').bootstrapToggle();
                $('#laddar').hide();
            }

            function ProcessNewPeople(newPeeps) {
                var grupp = $('input[name=groupRadio]:checked').val();
                var margin = ' style="margin-top:-5px"';
                doneDates = [];
                missingDates = [];

                $.each(newPeeps.feed.entry, function (i, entry) {
                    var id = entry.gsx$nynamn.$t.replace(/ /g, '_');
                    var peopleCount = 0;
                    if (entry.gsx$nynamn.$t !== "") {
                        peopleCount += 1;
                        var age = entry.gsx$ålder.$t;
                        if (age === "")
                            age = "fråga ålder!";
                        else
                            age = age + ' år';

                        var person = '<div class="form-group"' + margin + '>' +
                            '<div class="col-xs-2">' +
                            '<input type="checkbox" class="switch form-control" id="' + id + '" data-size="small" data-toggle="toggle" data-on="Ja" data-off="Nej" data-onstyle="success" data-offstyle="danger">' +
                            '</div><h4 style="font-size:1.2em;"><label style="text-align: left;" for="' + id + '" class="col-xs-10 control-label" data-name="' + entry.gsx$nynamn.$t + '">' + entry.gsx$nynamn.$t + ' <sup>' + age + '</sup></label></h4></span></div>';

                        if (grupp === entry.gsx$grupp.$t) {
                            $('div#namesHere').append(person);
                        }
                    }

                    var peoplePresent = entry.gsx$närvarande.$t.split("\n");

                    if (peoplePresent !== undefined)
                        peopleCount += peoplePresent.length - 1;

                    if (entry.gsx$grupp.$t === grupp) {
                        doneDates.push({ date: entry.gsx$datumstämpel.$t, count: peopleCount, sensei: entry.gsx$instruktör.$t });
                    }
                });

                $('.switch').bootstrapToggle();
                CreateDatepicker();
            }
        }

        function CreateDatepicker() {
            var grupp = $('input[name=groupRadio]:checked').val();
            $('#help-block').text('');
            $('#datePickme input').datepicker('clearDates');
            $('#datePickme input').datepicker('destroy');
            $('#datePickme input').datepicker({
                format: "DD d M",
                endDate: '+0d',
                weekStart: 1,
                maxViewMode: 0,
                language: "sv",
                keyboardNavigation: false,
                forceParse: false,
                calendarWeeks: true,
                autoclose: true,
                todayHighlight: true,
                beforeShowDay: function (date) {
                    dateFormat = moment(date).format('YYYY-MM-DD');
                    var weekday = moment(date).isoWeekday();
                    var testDate = moment();

                    if (moment(moment()).isSameOrAfter(moment(date), 'day')) {
                        if (grupp === 'Barn' || grupp === 'Vuxna') {
                            return Weekday(4, 7, weekday, dateFormat, date);
                        }
                        else if (grupp === 'Ungdomar') {
                            return Weekday(2, -1, weekday, dateFormat, date);
                        }
                        else if (grupp === 'Aikidolek') {
                            return Weekday(6, -1, weekday, dateFormat, date);
                        }
                    }
                }
            })
                .on('changeDate', function (e) {
                    var dateFormat = e.format('yyyy-mm-dd');
                    var dateItem = doneDates.find(function (element) {
                        return element.date === dateFormat;
                    });
                    if (dateItem !== undefined)
                        $('#help-block').text(dateItem.sensei + ' har registrerat ' + dateItem.count + ' deltagare.');
                    else
                        $('#help-block').text('');
                });


            function ClassPicker(doneDates, dateFormat, date) {
                //if (doneDates.map(dateFormat => -1).date)
                //if (doneDates.find(x => x.date === dateFormat))
                var doneItem = doneDates.find(function (element) {
                    return element.date === dateFormat;
                });
                if (doneItem !== undefined) {
                    return { content: moment(date).format('DD') + '<sup class="tinyNumbers">' + doneItem.count + '</sup>', classes: 'reported highlighted', tooltip: doneItem.count + ' närvarande' };
                }
                else
                    return { content: moment(date).format('DD') + '<sup class="tinyNumbers">0</sup>', classes: 'not-reported highlighted' };
            }

            function Weekday(firstDay, secondDay, weekDay, dateFormat, date) {
                if (weekDay === firstDay || weekDay === secondDay)
                    return ClassPicker(doneDates, dateFormat, date);
                else
                    return { classes: "disabled disabled-day" };
            }
        }


        if (window.performance) {
            //console.info("window.performance works fine on this browser");
            if (performance.navigation.type === 1) {
                //CheckIfReload();
            }
        }

        function setObject(key, obj) {
            localStorage.setObject(key, obj);
        }
        function getObject(key) {
            return localStorage.getObject(key);
        }

        Storage.prototype.setObject = function (key, value) {
            this.setItem(key, JSON.stringify(value));
        };

        Storage.prototype.getObject = function (key) {
            var value = this.getItem(key);
            return value && JSON.parse(value);
        };
    </script>

</head>
<body>

<div class="container-fluid">
  <div class="row">
  <form id="formValidateme" class="form-horizontal" role="form" data-toggle="validator">

	<div style="padding:10px;">
	<div class="form-group">
		<div class="col-xs-10">
		<!--<input type="checkbox" class="form-control" id="inputGroup" data-toggle="toggle" data-on="Vuxna" data-off="Barn" data-size="large" data-onstyle="warning" data-offstyle="info">-->
            <div class="btn-group" data-toggle="buttons">
                <label class="btn btn-lg active" style="border:1px solid #2ecc71;  width:50%">
                    <input type="radio" name="groupRadio" id="Barn" value="Barn" autocomplete="off" checked> Barn
                </label>
                <label class="btn btn-lg" style="border:1px solid #2ecc71; width:50%">
                    <input type="radio" name="groupRadio" id="Ungdomar" value="Ungdomar" autocomplete="off"> Ungdomar
                </label>
                <label class="btn btn-lg" style="border:1px solid #2ecc71; width:50%">
                    <input type="radio" name="groupRadio" id="Vuxna" value="Vuxna" autocomplete="off"> Vuxna
                </label>
                <label class="btn btn-lg" style="border:1px solid #2ecc71; width:50%">
                    <input type="radio" name="groupRadio" id="Aikidolek" value="Aikidolek" autocomplete="off"> Aikidolek
                </label>
            </div>
		</div>
		<div class="col-xs-10" style="padding-top:5px;">
			<div id="datePickme">
					<input type="text" id="classDate" autocomplete="off" class="form-control input-block" placeholder="Välj datum" data-error="Du måste fylla i datum!" data-required-error="Du måste fylla i datum!" required>
			</div>
			<div id="Who">
					<input type="text" id="InputWho" autocomplete="off" class="form-control input-block" placeholder="Ditt namn" data-error="Du måste fylla i ditt namn!" data-required-error="Du måste fylla i ditt namn!" required>
			</div>
		</div>
		<div style="margin: 5px">
	  <span id="laddar" class="glyphicon glyphicon-refresh spinning"></span>
 	  </div>
	<div class="col-xs-4"></div>
    <div class="col-xs-7">
        <div id="help-block"></div>
        <div class="help-block with-errors"></div>
    </div>			
	</div>	
		
	<div id="namesHere">
	</div>
<div class="form-group" style="padding-left:5px;">
	<div class="col-xs-11"><label for="nyaPersoner">Nya (om flera, skicka en i taget)</label></div>
	<div style="padding-left: 5px">
	<div>
	<h5><input placeholder="BARA EN PERSON! Förnamn Efternamn (fråga om stavning!)" id="nyaPersonerName" for="nyaPersoner" class="col-xs-10 control-label" /></h5>
	</div>
	<div>
	<h5><input placeholder="Födelsedatum ex 20181231" id="nyaPersonerBirth" for="nyaPersoner" class="col-xs-10 control-label" /></h5>
	</div>
	<div>
	<h5><input placeholder="Telefonnummer" id="nyaPersonerPhone" for="nyaPersoner" class="col-xs-10 control-label" /></h5>
	</div>
	</div>
        </div>
        <div class="form-group">
            <div class="col-xs-4"><label for="anteckning">Om passet:</label></div>
            <h4><input id="anteckning" for="anteckning" class="col-xs-7 control-label" /></h4>
        </div>
	
  <button id="submitForm" type="submit" class="btn btn-success btn-lg btn-block">Skicka in</button>
  </div>

  </form>
  </div>
</div>

<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>	
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js" integrity="sha256-eZNgBgutLI47rKzpfUji/dD9t6LRs2gI3YqXKdoDOmo=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js" integrity="sha256-De/cgZoAkgvqoxL9yJpJzPHyozUETFnSv7EQGfQWQ4o=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js" integrity="sha256-tW5LzEC7QjhG0CiAvxlseMTs2qJS7u3DRPauDjFJ3zo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.sv.min.js" integrity="sha256-P20FBA/CkDfREfXj49fDA5zDO0kTdmh9Mls+L9xipHw=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.5/validator.min.js" integrity="sha256-IxYUmOOk74FUrcx5FEMOHVmTJDb7ZAwnC/ivo/OQGxg=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-polyfills/0.1.22/polyfill.min.js" integrity="sha256-l1ITH+FkedkRS129jMQ/Ou0OS52L8fFl+RcOlNokraI=" crossorigin="anonymous"></script>
<script type="text/javascript">

    function postToGoogle() {
        var grupp = $('input[name=groupRadio]:checked').val();

        var datum = $('#classDate').data('datepicker').getFormattedDate('DD d M');
		var datestamp = $('#classDate').data('datepicker').getFormattedDate('yyyy-mm-dd');
		var nynamn = $('#nyaPersonerName').val();
		var nytelefon = $('#nyaPersonerPhone').val();
		var nybirth = $('#nyaPersonerBirth').val();
        var personer = "";
        var endline = "";
		
        var sensei = SetSensei();

        $('.switch:checkbox:checked').each(function () {
            var name = $('label[for="' + this.id + '"]').data("name"); //text();
            personer += endline + name;
            endline = '\n';
        });
        //personer += '\n' + 'Nya: ' + $('#nyaPersoner').val();
        personer += '\n' + 'Anteckning: ' + $('#anteckning').val();

        $.ajax({
            url: "https://docs.google.com/forms/d/e/1FAIpQLSe48Dap5E_C1ooZnHexeTccOpvLu3Yd1cxjEsWpEjG1S1zpQQ/formResponse",
            data: {
                "entry.518054362": grupp,
                "entry.1084298548": datum,
                "entry.918407859": personer,
				"entry.13933593": nynamn,
				"entry.84128144": nytelefon,
				"entry.590114014": nybirth,
				"entry.416881287": datestamp,
				"entry.444826897": sensei			
            },
            type: "POST",
            dataType: "xml",
            statusCode: {
                0: function () {
                    //Success message
                    //GetPeople();
                    $('#submitForm').text('Inskickat!');
                    $('div#namesHere').empty();
                    $('#nyaPersonerName').val('');
					$('#nyaPersonerBirth').val('');
					$('#nyaPersonerPhone').val('');
					$('#anteckning').val('');
                },
                200: function () {
                    //GetPeople();
                    //Success Message
                    $('#submitForm').text('Inskickat!');
                    $('div#namesHere').empty();
                    $('#nyaPersonerName').val('');
					$('#nyaPersonerBirth').val('');
					$('#nyaPersonerPhone').val('');
					$('#anteckning').val('');
                }
            }
        });
    }

</script>	
</body>
</html>
