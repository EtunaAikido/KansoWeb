{"version":3,"sources":["mavo.js"],"names":["$","$$","_","self","Mavo","Class","constructor","element","treeBuilt","defer","inProgress","index","Object","keys","all","length","defineProperty","value","selector","attributes","map","attribute","join","forEach","getAttribute","setAttribute","id","i","lang","closest","locale","Locale","get","autoEdit","classList","contains","autoSave","hasAttribute","autoSaveDelay","hooks","run","selectors","primitive","multiple","hasChildren","not","formControl","property","config","Primitive","getConfig","isCollection","is","expressions","Expressions","root","Group","resolve","permissions","Permissions","backendTypes","role","updateBackend","backendObserver","Observer","changed","roles","records","record","attributeName","replace","source","load","storage","init","data","can","Functions","$url","primaryBackend","login","addEventListener","evt","backend","unsavedChanges","bar","UI","Bar","target","document","activeElement","preventDefault","needsEdit","calculateNeedsEdit","setUnsavedChanges","onchange","action","trim","split","filter","a","push","modeObserver","nodeloop","Node","children","node","previousMode","mode","modes","getStyle","parentNode","subtree","edit","destroy","requestAnimationFrame","fire","debouncedSave","debounce","save","callback","saved","removeEventListener","unbind","keyCode","superKey","altKey","matches","editor","closestCollection","nextNode","getCousin","wrap","editing","immediately","then","focus","getData","o","toJSON","message","options","Message","error","type","dismiss","log","render","active","env","context","update","clear","confirm","store","events","remove","parent","toggle","walk","obj","done","previous","equals","Backend","create","mavo","format","Promise","ready","catch","reject","err","xhr","XMLHttpRequest","status","statusText","upload","file","path","name","uploadBackend","url","lastSaved","Date","now","test","nodeType","undefined","descentReturn","live","toggleAttribute","style","setProperty","_storage","_primaryBackend","removeProperty","static","Element","toNode","Symbol","navigator","platform","indexOf","base","location","protocol","currentScript","src","dependencies","container","mavos","Array","isArray","arguments","Hooks","lazy","documentElement","s","specificProperty","group","textInput","t","ui","arr","or","selector1","selector2","and","ret","arr2","s1","s2","andNot","extend","rootGroup","item","output","polyfills","each","from","URL","prototype","Intl","IntersectionObserver","supported","Plugins","include","inited","console","thenAll","Stretchy","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["/**\n * Mavo: Create web applications by writing HTML and CSS!\n * @author Lea Verou\n * @version v0.1.0\n */\n(function ($, $$) {\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\tthis.element = element;\n\n\t\tthis.inProgress = false;\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = Object.keys(_.all).length + 1;\n\t\tObject.defineProperty(_.all, this.index - 1, {value: this});\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar selector = _.attributes.map(attribute => `[data-${attribute}]`).join(\", \");\n\n\t\t[this.element, ...$$(selector, this.element)].forEach(element => {\n\t\t\tfor (let attribute of _.attributes) {\n\t\t\t\tlet value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`;\n\n\t\tif (this.id in _.all) {\n\t\t\t// Duplicate app name\n\t\t\tfor (var i=2; this.id + i in _.all; i++) {}\n\t\t\tthis.id = this.id + i;\n\t\t}\n\n\t\t_.all[this.id] = this;\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\tvar lang = $.value(this.element.closest(\"[lang]\"), \"lang\") || Mavo.locale;\n\t\tthis.locale = Mavo.Locale.get(lang);\n\n\t\t// Should we start in edit mode?\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\t// Should we save automatically?\n\t\tthis.autoSave = this.element.hasAttribute(\"mv-autosave\");\n\t\tthis.autoSaveDelay = (this.element.getAttribute(\"mv-autosave\") || 3) * 1000;\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\tMavo.hooks.run(\"init-start\", this);\n\n\t\t// Apply heuristic for groups\n\t\tfor (var element of $$(_.selectors.primitive + \",\" + _.selectors.multiple, this.element)) {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar config = Mavo.Primitive.getConfig(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !config.attribute && !config.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.expressions = new Mavo.Expressions(this);\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.permissions = new Mavo.Permissions();\n\n\t\tvar backendTypes = [\"source\", \"storage\", \"init\"]; // order is significant!\n\n\t\t// Figure out backends for storage, data reads, and initialization respectively\n\t\tfor (let role of backendTypes) {\n\t\t\tthis.updateBackend(role);\n\t\t}\n\n\t\tthis.backendObserver = new Mavo.Observer(this.element, backendTypes.map(role => \"mv-\" + role), records => {\n\t\t\tvar changed = {};\n\n\t\t\tvar roles = records.map(record => {\n\t\t\t\tvar role = record.attributeName.replace(/^mv-/, \"\");\n\t\t\t\tchanged[role] = this.updateBackend(role);\n\n\t\t\t\treturn role;\n\t\t\t});\n\n\t\t\t// Do we need to re-load data?\n\t\t\tif (changed.source) {  // if source changes, always reload\n\t\t\t\tthis.load();\n\t\t\t}\n\t\t\telse if (!this.source) {\n\t\t\t\tif (changed.storage || changed.init && !this.root.data) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.permissions.can(\"login\", () => {\n\t\t\t// We also support a URL param to trigger login, in case the user doesn't want visible login UI\n\t\t\tif (\"login\" in Mavo.Functions.$url && this.index == 1 || this.id + \"-login\" in Mavo.Functions.$url) {\n\t\t\t\tthis.primaryBackend.login();\n\t\t\t}\n\t\t});\n\n\t\t// Update login status\n\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\tif (evt.backend == (this.source || this.storage)) {\n\t\t\t\t// If last time we rendered we got nothing, maybe now we'll have better luck?\n\t\t\t\tif (!this.root.data && !this.unsavedChanges) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.bar = new Mavo.UI.Bar(this);\n\n\t\t// Prevent editing properties inside <summary> to open and close the summary (fix bug #82)\n\t\tif ($(\"summary [property]:not([typeof])\")) {\n\t\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\t\tif (evt.target != document.activeElement) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = this.calculateNeedsEdit();\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tvar permissions = this.element.getAttribute(\"mv-permissions\") || \"\";\n\t\t\tpermissions = permissions.trim().split(/\\s+/).filter(a => a != action);\n\n\t\t\tif (value) {\n\t\t\t\tpermissions.push(action);\n\t\t\t}\n\n\t\t\tthis.element.setAttribute(\"mv-permissions\", permissions.join(\" \"));\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\t\t// Observe entire tree for mv-mode changes\n\t\t\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\t\t\tfor (let record of records) {\n\t\t\t\t\t\tlet element = record.target;\n\n\t\t\t\t\t\tnodeloop: for (let node of _.Node.children(element)) {\n\t\t\t\t\t\t\tlet previousMode = node.mode, mode;\n\n\t\t\t\t\t\t\tif (node.element == element) {\n\t\t\t\t\t\t\t\t// If attribute set directly on a Mavo node, then it forces it into that mode\n\t\t\t\t\t\t\t\t// otherwise, descendant nodes still inherit, unless they are also mode-restricted\n\t\t\t\t\t\t\t\tmode = node.element.getAttribute(\"mv-mode\");\n\t\t\t\t\t\t\t\tnode.modes = mode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t// Inherited\n\t\t\t\t\t\t\t\tif (node.modes) {\n\t\t\t\t\t\t\t\t\t// Mode-restricted, we cannot change to the other mode\n\t\t\t\t\t\t\t\t\tcontinue nodeloop;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tmode = _.getStyle(node.element.parentNode, \"--mv-mode\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnode.mode = mode;\n\n\t\t\t\t\t\t\tif (previousMode != node.mode) {\n\t\t\t\t\t\t\t\tnode[node.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, {subtree: true});\n\n\t\t\t\tif (this.autoEdit) {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t}, () => { // cannot\n\t\t\t\tthis.modeObserver && this.modeObserver.destroy();\n\t\t\t});\n\t\t}\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage or source\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"save\", () => {\n\t\t\tif (this.autoSave) {\n\t\t\t\tthis.element.addEventListener(\"mavo:load.mavo:autosave\", evt => {\n\t\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t}, this.autoSaveDelay);\n\n\t\t\t\t\tvar callback = evt => {\n\t\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t}, () => {\n\t\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}, () => {\n\t\t\t$.unbind(this.element, \".mavo:save .mavo:autosave\");\n\t\t});\n\n\t\t// Keyboard navigation\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\t// Ctrl + S or Cmd + S to save\n\t\t\tif (this.permissions.save && evt.keyCode == 83 && evt[_.superKey] && !evt.altKey) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t\telse if (evt.keyCode == 38 || evt.keyCode == 40) {\n\t\t\t\tvar element = evt.target;\n\n\t\t\t\tif (element.matches(\"textarea, input[type=range], input[type=number]\")) {\n\t\t\t\t\t// Arrow keys are meaningful here\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (element.matches(\".mv-editor\")) {\n\t\t\t\t\tvar editor = true;\n\t\t\t\t\telement = element.parentNode;\n\t\t\t\t}\n\n\t\t\t\tvar node = Mavo.Node.get(element);\n\n\t\t\t\tif (node && node.closestCollection) {\n\t\t\t\t\tvar nextNode = node.getCousin(evt.keyCode == 38? -1 : 1, {wrap: true});\n\n\t\t\t\t\tif (nextNode) {\n\t\t\t\t\t\tif (editor && nextNode.editing) {\n\t\t\t\t\t\t\tnextNode.edit({immediately: true}).then(() => nextNode.editor.focus());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tnextNode.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function() {\n\t\treturn _.toJSON(this.getData());\n\t},\n\n\tmessage: function(message, options) {\n\t\treturn new _.UI.Message(this, message, options);\n\t},\n\n\terror: function(message, ...log) {\n\t\tthis.message(message, {\n\t\t\ttype: \"error\",\n\t\t\tdismiss: [\"button\", \"timeout\"]\n\t\t});\n\n\t\t// Log more info for programmers\n\t\tif (log.length > 0) {\n\t\t\tconsole.log(`%c${this.id}: ${message}`, \"color: red; font-weight: bold\", ...log);\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.expressions.active = false;\n\n\t\tvar env = {context: this, data};\n\t\t_.hooks.run(\"render-start\", env);\n\n\t\tif (env.data) {\n\t\t\tthis.root.render(env.data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\n\t\tthis.expressions.active = true;\n\t\trequestAnimationFrame(() => this.expressions.update());\n\n\t\t_.hooks.run(\"render-end\", env);\n\t},\n\n\tclear: function() {\n\t\tif (confirm(this._(\"delete-confirmation\"))) {\n\t\t\tthis.store(null).then(() => this.root.clear());\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(_.selectors.multiple)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.multiple);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * Update the backend for a given role\n\t * @return {Boolean} true if a change occurred, false otherwise\n\t */\n\tupdateBackend: function(role) {\n\t\tvar previous = this[role], backend;\n\n\t\tif (this.index == 1) {\n\t\t\tbackend = _.Functions.$url[role];\n\t\t}\n\n\t\tif (!backend) {\n\t\t\tbackend =  _.Functions.$url[`${this.id}-${role}`] || this.element.getAttribute(\"mv-\" + role) || null;\n\t\t}\n\n\t\tif (backend) {\n\t\t\tbackend = backend.trim();\n\n\t\t\tif (backend == \"none\") {\n\t\t\t\tbackend = null;\n\t\t\t}\n\t\t}\n\n\t\tif (backend && (!previous || !previous.equals(backend))) {\n\t\t\t// We have a string, convert to a backend object if different than existing\n\t\t\tthis[role] = backend = _.Backend.create(backend, {\n\t\t\t\tmavo: this,\n\t\t\t\tformat: this.element.getAttribute(`mv-${role}-format`) || this.element.getAttribute(\"mv-format\")\n\t\t\t}, this.element.getAttribute(`mv-${role}-type`));\n\t\t}\n\t\telse if (!backend) {\n\t\t\t// We had a backend and now we will un-have it\n\t\t\tthis[role] = null;\n\t\t}\n\n\t\tvar changed = backend? !backend.equals(previous) : !!previous;\n\n\t\tif (changed) {\n\t\t\t// A change occured\n\t\t\tif (!this.storage && !this.source && this.init) {\n\t\t\t\t// If init is present with no storage and no source, init is equivalent to source\n\t\t\t\tthis.source = this.init;\n\t\t\t\tthis.init = null;\n\t\t\t}\n\n\t\t\tvar permissions = this.storage? this.storage.permissions : new Mavo.Permissions({edit: true, save: false});\n\t\t\tpermissions.parent = this.source && this.source.permissions;\n\t\t\tthis.permissions.parent = permissions;\n\n\t\t\tthis.primaryBackend = this.storage || this.source;\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tvar backend = this.source || this.storage;\n\n\t\tif (!backend) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.inProgress = \"Loading\";\n\n\t\treturn backend.ready.then(() => backend.load())\n\t\t.catch(err => {\n\t\t\t// Try again with init\n\t\t\tif (this.init && this.init != backend) {\n\t\t\t\tbackend = this.init;\n\t\t\t\treturn this.init.ready.then(() => this.init.load());\n\t\t\t}\n\n\t\t\t// No init, propagate error\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tvar xhr = err instanceof XMLHttpRequest? err : err.xhr;\n\n\t\t\t\tif (xhr && xhr.status == 404) {\n\t\t\t\t\tthis.render(null);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar message = \"Problem loading data\";\n\n\t\t\t\t\tif (xhr) {\n\t\t\t\t\t\tmessage += xhr.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t})\n\t\t.then(data => this.render(data))\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\treturn this.storage.store(this.getData())\n\t\t\t.catch(err => {\n\t\t\t\tif (err) {\n\t\t\t\t\tvar message = this._(\"problem-saving\");\n\n\t\t\t\t\tif (err instanceof XMLHttpRequest) {\n\t\t\t\t\t\tmessage += \": \" + (err.status? this._(\"http-error\", err) : this._(\"cant-connect\"));\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t})\n\t\t\t.then(saved => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn saved;\n\t\t\t});\n\t},\n\n\tupload: function(file, path = \"images/\" + file.name) {\n\t\tif (!this.uploadBackend) {\n\t\t\treturn Promise.reject();\n\t\t}\n\n\t\tthis.inProgress = this._(\"uploading\");\n\n\t\treturn this.uploadBackend.upload(file, path)\n\t\t\t.then(url => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn url;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tthis.error(this._(\"error-uploading\"), err);\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn null;\n\t\t\t});\n\t},\n\n\tsave: function() {\n\t\treturn this.store().then(saved => {\n\t\t\tif (saved) {\n\t\t\t\t$.fire(this.element, \"mavo:save\", saved);\n\n\t\t\t\tthis.lastSaved = Date.now();\n\t\t\t\tthis.root.save();\n\t\t\t\tthis.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\twalk: function(callback) {\n\t\treturn this.root.walk(callback);\n\t},\n\n\tcalculateNeedsEdit: function(test) {\n\t\tvar needsEdit = false;\n\n\t\tthis.walk((obj, path) => {\n\t\t\tif (needsEdit) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tneedsEdit = !obj.modes && obj.nodeType != \"Group\";\n\n\t\t\treturn obj.modes? undefined : true;\n\t\t}, undefined, {\n\t\t\tdescentReturn: true\n\t\t});\n\n\t\treturn needsEdit;\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t\t$.toggleAttribute(this.element, \"aria-busy\", !!value, !!value);\n\t\t\tthis.element.style.setProperty(\"--mv-progress-text\", value? `\"${this._(value)}\"` : \"\");\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\tthis.bar.toggle(\"edit\", value && this.permissions.edit);\n\t\t},\n\n\t\tstorage: function(value) {\n\t\t\tif (value !== this._storage && !value) {\n\t\t\t\tvar permissions = new Mavo.Permissions({edit: true, save: false});\n\t\t\t\tpermissions.parent = this.permissions.parent;\n\t\t\t\tthis.permissions.parent = permissions;\n\t\t\t}\n\t\t},\n\n\t\tprimaryBackend: function(value) {\n\t\t\tvalue = value || null;\n\n\t\t\tif (value != this._primaryBackend) {\n\t\t\t\tif (value)  {\n\t\t\t\t\tthis.element.style.setProperty(\"--mv-backend\", `\"${value.id}\"`);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.element.style.removeProperty(\"--mv-backend\");\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\t\t},\n\n\t\tuploadBackend: {\n\t\t\tget: function() {\n\t\t\t\tif (this.storage && this.storage.upload) {\n\t\t\t\t\t// Prioritize storage\n\t\t\t\t\treturn this.storage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: {},\n\n\t\tget: function(id) {\n\t\t\tif (id instanceof Element) {\n\t\t\t\t// Get by element\n\t\t\t\tfor (var name in _.all) {\n\t\t\t\t\tif (_.all[name].element == id) {\n\t\t\t\t\t\treturn _.all[name];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tvar name = typeof id === \"number\"? Object.keys(_.all)[id] : id;\n\n\t\t\treturn _.all[name] || null;\n\t\t},\n\n\t\ttoNode: Symbol(\"toNode\"),\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\t\tbase: location.protocol == \"about:\"? (document.currentScript? document.currentScript.src : \"http://mavo.io\") : location,\n\t\tdependencies: [],\n\n\t\tinit: function(container = document) {\n\t\t\tvar mavos = Array.isArray(arguments[0])? arguments[0] : $$(_.selectors.init, container);\n\n\t\t\treturn mavos.filter(element => !_.get(element)) // not already inited\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\tUI: {},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-source\", \"mv-init\", \"mv-path\", \"mv-format\",\n\t\t\t\"mv-attribute\", \"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\",\n\t\t\t\"mv-rel\"\n\t\t],\n\n\t\tlazy: {\n\t\t\tlocale: () => document.documentElement.lang || \"en-GB\"\n\t\t}\n\t}\n});\n\nObject.defineProperty(_.all, \"length\", {\n\tget: function() {\n\t\treturn Object.keys(this).length;\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], [mv-group]\",\n\tmultiple: \"[mv-multiple]\",\n\tformControl: \"input, select, option, textarea\",\n\ttextInput: [\"text\", \"email\", \"url\", \"tel\", \"search\"].map(t => `input[type=${t}]`).join(\", \") + \", input:not([type]), textarea\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t// \"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t// \"dt\": \"dl\",\n\t\t// \"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\titem: or(s.multiple, s.group),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output\")\n});\n\n}\n\n// Init mavo. Async to give other scripts a chance to modify stuff.\nrequestAnimationFrame(() => {\n\tvar polyfills = [];\n\n\t$.each({\n\t\t\"blissfuljs\": Array.from && document.documentElement.closest && self.URL && \"searchParams\" in URL.prototype,\n\t\t\"Intl.~locale.en\": self.Intl,\n\t\t\"IntersectionObserver\": self.IntersectionObserver,\n\t\t\"Symbol\": self.Symbol\n\t}, (id, supported) => {\n\t\tif (!supported) {\n\t\t\tpolyfills.push(id);\n\t\t}\n\t});\n\n\t_.dependencies.push(\n\t\t$.ready(),\n\t\t_.Plugins.load(),\n\t\t$.include(!polyfills.length, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=\" + polyfills.join(\",\"))\n\t);\n\n\t_.inited = $.ready().then(() => {\n\t\t$.attributes($$(_.selectors.init), {\"mv-progress\": \"Loading\"});\n\t\treturn _.ready;\n\t})\n\t.catch(console.error)\n\t.then(() => Mavo.init());\n\n\t_.ready = _.thenAll(_.dependencies);\n});\n\nStretchy.selectors.filter = \".mv-editor:not([property]), .mv-autosize\";\n\n})(Bliss, Bliss.$);\n"]}