<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Tsuzukiwazas</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <!-- PWA & Mobile App Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest_tw.json">
    <link rel="icon" href="/fav/logoWB128x.webp" type="image/webp" sizes="128x128">
    <link rel="apple-touch-icon" href="/fav/logoWB128x.webp">
    
    <!-- Libraries & Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <!-- DEFINITIVE FIX: Using jsDelivr to load the EXACT correct version of lazyYT CSS from the original author -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Daugilas/lazyYT@a52252c3/lazyYT.css">
    
    <style>
        body { padding-top: 30px; }
        .jumbotron { background-color: #ffffff !important; }
        h1, h2, h3, h4, h5, h6 { color: black; }
        .article-intro { margin-bottom: 25px; }
        .footer-blurb-item { padding: 10px 10px 10px 20px; }
        .small-print { background-color: #000000; padding: 30px 0; }
        
        /* Ensure navbar toggle works on all screen sizes */
        .navbar-collapse.collapse { display: none !important; }
        .navbar-collapse.collapse.in { display: block !important; }
        .navbar-header .collapse, .navbar-toggle { display: block !important; }
        .navbar-header { float: none; }
        
        /* Loading Spinner Animation */
        .glyphicon-refresh-animate {
            animation: spin 1.5s infinite linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
                <ul id="navul" class="nav navbar-nav"></ul>
            </div>
        </div>
    </nav>

    <div class="jumbotron feature">
        <div class="container">
            <div id="loader" class="text-center">
                <span style="font-size:10em;" class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>
            </div>
            <div id="content" style="display:none;">
                <p id="topic"></p>
                <ul id="description"></ul>
                <p id="Yoshimovie"></p>
            </div>
        </div>
    </div>
    
    <div class="container" id="moviesDiv" style="display:none">
        <div class="row" id="movies"></div>
    </div>

    <footer id="footerDiv" style="display:none">
        <div class="footer-blurb">
            <div class="container">
                <div class="row">
                    <div class="col-sm-4 footer-blurb-item">
                        <h3><span class="glyphicon glyphicon-fire"></span> Klassificering</h3>
                        <p id="Klassificering"></p>
                    </div>
                    <div class="col-sm-4 footer-blurb-item">
                        <h3><span class="glyphicon glyphicon-cloud-upload"></span> Ordlista</h3>
                        <ul id="Ordlista"></ul>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- SCRIPT SECTION -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DEFINITIVE FIX: Using jsDelivr to load the EXACT correct version of lazyYT JS from the original author -->
    <script src="https://cdn.jsdelivr.net/gh/Daugilas/lazyYT@a52252c3/lazyYT.js"></script>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {

    // --- CONFIGURATION ---
    const API_KEY = "AIzaSyBRmv4SKsS_oDZUTTXWwhn8HS6GSgC25JM";
    const SPREADSHEET_ID = "1DBGA8wHPPVc_gbpIlMmUIwHSdHqCg_ZnKzwoYfDX2B4";
    const DATA_SHEET_NAME = "Tsuzukiwaza";
    const DICT_SHEET_NAME = "Ordlista";
    const YOUTUBE_PLAYER_KEY = "AIzaSyC911J-UtcGPB8SIWUm-_Her-fXBusUdwI";
    // ---------------------

    // --- HELPER FUNCTIONS ---
    function getQueryParam(key) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(key);
    }
    function sheetDataToObjectArray(values) {
        const headers = values[0].map(h => h.toLowerCase());
        const dataRows = values.slice(1);
        return dataRows.map(row => {
            const rowObject = {};
            headers.forEach((header, index) => {
                rowObject[header] = row[index];
            });
            return rowObject;
        });
    }
    function getYoutubeId(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
    function displayError(message, details = "") {
        $('#loader').hide();
        $('#content').show();
        $('#topic').html(`
            <div class="alert alert-danger">
                <h4>Error</h4>
                <p>${message}</p>
                <small>${details}</small>
            </div>
        `);
    }

    // --- RENDER FUNCTIONS ---
    function renderNavigation(data, currentNr) {
        const navHtml = data.map(entry => `
            <li class="${entry.nummer === currentNr ? 'active' : ''}">
                <a href="?nr=${entry.nummer}">TW ${entry.nummer} ${entry.attack}</a>
            </li>
        `).join('');
        $('#navul').html(navHtml);
    }
    function renderContent(entry) {
        $('#topic').html(`<h3>Tsuzukiwaza ${entry.nummer}</h3><h1>${entry.attack}</h1>`);
        $('#Yoshimovie').html(`<a href="${entry.filmyoshigasaki}" target="_blank" rel="noopener noreferrer">Yoshigasakis film (ekia2012)</a>`);
        let descriptionHtml = '';
        for (let i = 1; i < 15; i++) {
            const technique = entry[`teknik${i}`];
            if (technique) {
                descriptionHtml += `<li>${technique}</li>`;
            }
        }
        $('#description').html(descriptionHtml);
    }
    function renderMovies(entry) {
        let moviesHtml = '';
        for (let i = 1; i < 11; i++) {
            const filmUrl = entry[`film${i}`];
            const videoId = getYoutubeId(filmUrl);
            if (videoId) {
                moviesHtml += `
                    <article class="col-md-8 article-intro">
                        <div class="embed-responsive embed-responsive-16by9">
                            <div class="lazyYT" data-youtube-id="${videoId}">Loading video...</div>
                        </div>
                    </article>
                `;
            }
        }
        $('#movies').html(moviesHtml);
        // This call will now work with the correct library version loaded.
        $('.lazyYT').lazyYT(YOUTUBE_PLAYER_KEY);
    }
    function renderFooter(entry, dictData) {
        $('#Klassificering').html(marked.parse(entry.klassificering || ''));
        const finder = (entry.ordlista || "").split(';').filter(Boolean);
        if (finder.length > 0) {
            let wordsHtml = '';
            const dictionaryMap = new Map(dictData.map(item => [item.nummer, item]));
            finder.forEach(num => {
                const desc = dictionaryMap.get(num);
                if(desc) {
                    wordsHtml += `<li><strong>${desc.word}</strong> - ${desc.description}</li>`;
                }
            });
            $('#Ordlista').html(wordsHtml);
        }
    }
    
    // --- MAIN LOGIC ---
    async function main() {
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_SHEET_NAME}?key=${API_KEY}`;
        const dictUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DICT_SHEET_NAME}?key=${API_KEY}`;

        try {
            const [dataResponse, dictResponse] = await Promise.all([ fetch(dataUrl), fetch(dictUrl) ]);
            if (!dataResponse.ok) throw new Error(`Failed to load main data. Status: ${dataResponse.status}. Check API Key, Spreadsheet ID, and Sheet Name.`);
            if (!dictResponse.ok) throw new Error(`Failed to load dictionary data. Status: ${dictResponse.status}.`);
            const dataJson = await dataResponse.json();
            const dictJson = await dictResponse.json();
            const mainData = sheetDataToObjectArray(dataJson.values);
            const dictData = sheetDataToObjectArray(dictJson.values);
            const currentNr = getQueryParam('nr') || '1';
            const currentEntry = mainData.find(entry => entry.nummer === currentNr);
            renderNavigation(mainData, currentNr);
            if (currentEntry) {
                renderContent(currentEntry);
                renderMovies(currentEntry);
                renderFooter(currentEntry, dictData);
                $('#loader').hide();
                $('#content, #moviesDiv, #footerDiv').show();
            } else {
                displayError(`Item number "${currentNr}" was not found.`);
            }
        } catch (error) {
            console.error(error);
            displayError('Could not load data from Google Sheets.', 'Please check the browser console for more details and ensure the spreadsheet is shared with "Anyone with the link".');
        }
    }

    main();
});
</script>

<!-- Google Analytics -->
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>
    window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
    ga('create', 'UA-11823715-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>